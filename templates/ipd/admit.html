{% extends "base.html" %}

{% block title %}IPD Admission - {{ hospital_name }}{% endblock %}

{% block module_name %}IPD Admission{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-bed me-2"></i>IPD Admission</h2>
        <p class="text-muted">Admit a patient to In-Patient Department</p>
        <hr>
    </div>
</div>

<!-- Step 1: Search Patient -->
<div class="row mb-4" id="step1-search">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-search me-2"></i>Step 1: Search Patient
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="patientSearch" class="required">Patient ID or Mobile Number</label>
                    <div class="input-group">
                        <input type="text" 
                               class="form-control search-input" 
                               id="patientSearch" 
                               placeholder="Enter Patient ID or Mobile Number"
                               autofocus>
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                    <small class="text-muted">Enter patient ID (e.g., PAT001) or mobile number</small>
                </div>
                
                <div id="patientResult" class="mt-3" style="display: none;">
                    <!-- Patient details will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Step 2: IPD Admission Form -->
<div class="row" id="step2-admit" style="display: none;">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bed me-2"></i>Step 2: IPD Admission Details
            </div>
            <div class="card-body">
                <form id="ipdAdmitForm">
                    <input type="hidden" id="selectedPatientId" name="patient_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="wardType" class="required">Ward Type</label>
                                <select class="form-select" id="wardType" name="ward_type" required>
                                    <option value="">Select Ward Type</option>
                                    <option value="GENERAL">General Ward</option>
                                    <option value="SEMI_PRIVATE">Semi-Private Ward</option>
                                    <option value="PRIVATE">Private Ward</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bedSelect" class="required">Select Bed</label>
                                <select class="form-select" id="bedSelect" name="bed_id" required disabled>
                                    <option value="">First select ward type</option>
                                </select>
                                <small class="text-muted" id="bedInfo"></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fileCharge" class="required">File Charge (₹)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="fileCharge" 
                                       name="file_charge" 
                                       value="500" 
                                       min="0" 
                                       step="0.01" 
                                       required>
                                <small class="text-muted">One-time IPD file charge</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="admissionDate">Admission Date & Time</label>
                                <input type="datetime-local" 
                                       class="form-control" 
                                       id="admissionDate" 
                                       name="admission_date">
                                <small class="text-muted">Leave blank for current date/time</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary me-2" id="backBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Search
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="admitBtn">
                                <i class="fas fa-bed me-2"></i>Admit Patient
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bed Occupancy Summary -->
<div class="row mt-4">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Current Bed Occupancy
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 id="totalBeds">-</h3>
                        <p class="text-muted">Total Beds</p>
                    </div>
                    <div class="col-md-3">
                        <h3 id="availableBeds" class="text-success">-</h3>
                        <p class="text-muted">Available</p>
                    </div>
                    <div class="col-md-3">
                        <h3 id="occupiedBeds" class="text-danger">-</h3>
                        <p class="text-muted">Occupied</p>
                    </div>
                    <div class="col-md-3">
                        <h3 id="occupancyRate">-</h3>
                        <p class="text-muted">Occupancy Rate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedPatient = null;

// Load bed occupancy on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBedOccupancy();
    
    // Auto-focus search input
    document.getElementById('patientSearch').focus();
    
    // Search on Enter key
    document.getElementById('patientSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPatient();
        }
    });
});

// Search patient
document.getElementById('searchBtn').addEventListener('click', searchPatient);

async function searchPatient() {
    const query = document.getElementById('patientSearch').value.trim();
    
    if (!query) {
        showToast('Please enter Patient ID or Mobile Number', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/patients/search?query=${encodeURIComponent(query)}`);
        
        if (!response.ok) {
            throw new Error('Patient not found');
        }
        
        const patients = await response.json();
        
        if (patients.length === 0) {
            showToast('No patient found with that ID or mobile number', 'error');
            document.getElementById('patientResult').style.display = 'none';
            return;
        }
        
        // Show first matching patient
        selectedPatient = patients[0];
        displayPatientInfo(selectedPatient);
        
    } catch (error) {
        console.error('Error searching patient:', error);
        showToast('Error searching for patient', 'error');
    }
}

function displayPatientInfo(patient) {
    const resultDiv = document.getElementById('patientResult');
    
    resultDiv.innerHTML = `
        <div class="patient-summary-card alert alert-success">
            <h5><i class="fas fa-user-check me-2"></i>Patient Found</h5>
            <div class="row mt-3">
                <div class="col-md-6">
                    <p><strong>Patient ID:</strong> ${patient.patient_id}</p>
                    <p><strong>Name:</strong> ${patient.name}</p>
                    <p><strong>Age/Gender:</strong> ${patient.age} years / ${patient.gender}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Mobile:</strong> ${patient.mobile_number}</p>
                    <p><strong>Address:</strong> ${patient.address || 'N/A'}</p>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-2" id="proceedBtn">
                <i class="fas fa-arrow-right me-2"></i>Proceed to Admission
            </button>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    
    // Add proceed button handler
    document.getElementById('proceedBtn').addEventListener('click', showAdmissionForm);
}

function showAdmissionForm() {
    document.getElementById('step1-search').style.display = 'none';
    document.getElementById('step2-admit').style.display = 'block';
    document.getElementById('selectedPatientId').value = selectedPatient.patient_id;
    
    // Scroll to form
    document.getElementById('step2-admit').scrollIntoView({ behavior: 'smooth' });
}

// Back button
document.getElementById('backBtn').addEventListener('click', function() {
    document.getElementById('step2-admit').style.display = 'none';
    document.getElementById('step1-search').style.display = 'block';
    document.getElementById('ipdAdmitForm').reset();
    document.getElementById('patientSearch').focus();
});

// Ward type change - load available beds
document.getElementById('wardType').addEventListener('change', async function() {
    const wardType = this.value;
    const bedSelect = document.getElementById('bedSelect');
    
    if (!wardType) {
        bedSelect.disabled = true;
        bedSelect.innerHTML = '<option value="">First select ward type</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/ipd/beds/available?ward_type=${wardType}`);
        const beds = await response.json();
        
        bedSelect.innerHTML = '<option value="">Select Bed</option>';
        
        if (beds.length === 0) {
            bedSelect.innerHTML = '<option value="">No beds available in this ward</option>';
            bedSelect.disabled = true;
            document.getElementById('bedInfo').textContent = 'No beds available';
            return;
        }
        
        beds.forEach(bed => {
            const option = document.createElement('option');
            option.value = bed.bed_id;
            option.textContent = `${bed.bed_number} - ₹${bed.per_day_charge}/day`;
            option.dataset.charge = bed.per_day_charge;
            bedSelect.appendChild(option);
        });
        
        bedSelect.disabled = false;
        document.getElementById('bedInfo').textContent = `${beds.length} bed(s) available`;
        
    } catch (error) {
        console.error('Error loading beds:', error);
        showToast('Error loading available beds', 'error');
    }
});

// Bed selection - show charge info
document.getElementById('bedSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.dataset.charge) {
        document.getElementById('bedInfo').textContent = `Charge: ₹${selectedOption.dataset.charge} per day`;
    }
});

// Submit IPD admission form
document.getElementById('ipdAdmitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const admitBtn = document.getElementById('admitBtn');
    const originalText = admitBtn.innerHTML;
    
    // Disable button and show spinner
    admitBtn.disabled = true;
    admitBtn.innerHTML = '<span class="btn-spinner me-2"></span>Admitting...';
    
    try {
        const formData = {
            patient_id: document.getElementById('selectedPatientId').value,
            bed_id: document.getElementById('bedSelect').value,
            file_charge: parseFloat(document.getElementById('fileCharge').value),
            admission_date: document.getElementById('admissionDate').value || null
        };
        
        const response = await fetch('/api/v1/ipd/admit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to admit patient');
        }
        
        const admission = await response.json();
        
        // Success
        showToast('Patient admitted successfully!', 'success');
        
        // Show success message and redirect
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
        
    } catch (error) {
        console.error('Error admitting patient:', error);
        showToast(error.message || 'Error admitting patient', 'error');
        
        // Re-enable button
        admitBtn.disabled = false;
        admitBtn.innerHTML = originalText;
    }
});

// Load bed occupancy stats
async function loadBedOccupancy() {
    try {
        const response = await fetch('/api/v1/ipd/beds/occupancy');
        const stats = await response.json();
        
        document.getElementById('totalBeds').textContent = stats.total_beds;
        document.getElementById('availableBeds').textContent = stats.available;
        document.getElementById('occupiedBeds').textContent = stats.occupied;
        document.getElementById('occupancyRate').textContent = `${stats.occupancy_rate.toFixed(1)}%`;
        
    } catch (error) {
        console.error('Error loading bed occupancy:', error);
    }
}
</script>
{% endblock %}
