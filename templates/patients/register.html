{% extends "base.html" %}

{% block title %}Patient Registration - {{ hospital_name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Patient Registration</h1>
        <p class="subtitle">Register new patient or search existing patients</p>
    </div>

    <!-- Search Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h2>Search Existing Patient</h2>
        </div>
        <div class="card-body">
            <form id="searchForm" class="form-inline">
                <div class="form-group">
                    <label for="searchType">Search By:</label>
                    <select id="searchType" class="form-control">
                        <option value="mobile">Mobile Number</option>
                        <option value="id">Patient ID</option>
                        <option value="name">Name</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="searchTerm" class="form-control" placeholder="Enter search term" required>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            
            <div id="searchResults" class="mt-3"></div>
        </div>
    </div>

    <!-- Registration Form -->
    <div class="card">
        <div class="card-header">
            <h2>New Patient Registration</h2>
        </div>
        <div class="card-body">
            <form id="registrationForm">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="patientName">Patient Name <span class="required">*</span></label>
                        <input type="text" class="form-control" id="patientName" name="name" required>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="patientAge">Age <span class="required">*</span></label>
                        <input type="number" class="form-control" id="patientAge" name="age" min="0" max="150" required>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="patientGender">Gender <span class="required">*</span></label>
                        <select class="form-control" id="patientGender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="mobileNumber">Mobile Number <span class="required">*</span></label>
                        <input type="tel" class="form-control" id="mobileNumber" name="mobile_number" 
                               pattern="[6-9][0-9]{9}" placeholder="10-digit mobile number" required>
                        <small class="form-text text-muted">Enter 10-digit mobile number starting with 6-9</small>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="patientAddress">Address <span class="required">*</span></label>
                        <textarea class="form-control" id="patientAddress" name="address" rows="1" required></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Register Patient</button>
                    <button type="reset" class="btn btn-secondary">Clear Form</button>
                </div>
            </form>

            <div id="registrationResult" class="mt-3"></div>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    margin-bottom: 5px;
}

.subtitle {
    color: #7f8c8d;
    font-size: 14px;
}

.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.card-header {
    background: #3498db;
    color: white;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0;
}

.card-header h2 {
    margin: 0;
    font-size: 18px;
}

.card-body {
    padding: 20px;
}

.form-inline {
    display: flex;
    gap: 15px;
    align-items: flex-end;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.required {
    color: #e74c3c;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.col-md-3 {
    flex: 0 0 25%;
}

.col-md-6 {
    flex: 0 0 50%;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

.alert {
    padding: 12px 15px;
    border-radius: 4px;
    margin-top: 15px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.search-result-item {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.patient-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.patient-details {
    flex: 1;
}

.patient-id {
    font-weight: 600;
    color: #3498db;
}

.mb-3 {
    margin-bottom: 15px;
}

.mb-4 {
    margin-bottom: 30px;
}

.mt-3 {
    margin-top: 15px;
}
</style>

<script>
// Search functionality
document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const searchType = document.getElementById('searchType').value;
    const searchTerm = document.getElementById('searchTerm').value.trim();
    
    if (!searchTerm) {
        showMessage('searchResults', 'Please enter a search term', 'error');
        return;
    }
    
    try {
        const params = new URLSearchParams();
        if (searchType === 'mobile') {
            params.append('mobile_number', searchTerm);
        } else if (searchType === 'id') {
            params.append('patient_id', searchTerm);
        } else {
            params.append('name', searchTerm);
        }
        
        const response = await fetch(`/api/v1/patients/search?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            displaySearchResults(data);
        } else {
            showMessage('searchResults', data.detail || 'Search failed', 'error');
        }
    } catch (error) {
        showMessage('searchResults', 'Error performing search: ' + error.message, 'error');
    }
});

// Display search results
function displaySearchResults(patients) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (patients.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-error">No patients found</div>';
        return;
    }
    
    let html = '<h3>Search Results:</h3>';
    patients.forEach(patient => {
        html += `
            <div class="search-result-item" onclick="viewPatient('${patient.patient_id}')">
                <div class="patient-info">
                    <div class="patient-details">
                        <div class="patient-id">${patient.patient_id}</div>
                        <div><strong>${patient.name}</strong> - ${patient.age} years, ${patient.gender}</div>
                        <div>Mobile: ${patient.mobile_number}</div>
                        <div>Address: ${patient.address}</div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="event.stopPropagation(); fillForm('${patient.patient_id}')">
                            Update
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

// View patient details
function viewPatient(patientId) {
    window.location.href = `/patients/${patientId}`;
}

// Fill form for update
async function fillForm(patientId) {
    try {
        const response = await fetch(`/api/v1/patients/${patientId}`);
        const patient = await response.json();
        
        if (response.ok) {
            document.getElementById('patientName').value = patient.name;
            document.getElementById('patientAge').value = patient.age;
            document.getElementById('patientGender').value = patient.gender;
            document.getElementById('mobileNumber').value = patient.mobile_number;
            document.getElementById('patientAddress').value = patient.address;
            
            // Change form to update mode
            const form = document.getElementById('registrationForm');
            form.dataset.patientId = patientId;
            form.querySelector('button[type="submit"]').textContent = 'Update Patient';
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        showMessage('registrationResult', 'Error loading patient data: ' + error.message, 'error');
    }
}

// Registration form submission
document.getElementById('registrationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convert age to number
    data.age = parseInt(data.age);
    
    const patientId = e.target.dataset.patientId;
    const isUpdate = !!patientId;
    
    try {
        const url = isUpdate ? `/api/v1/patients/${patientId}` : '/api/v1/patients/';
        const method = isUpdate ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            const message = isUpdate 
                ? `Patient ${result.patient_id} updated successfully!`
                : `Patient registered successfully! Patient ID: ${result.patient_id}`;
            
            showMessage('registrationResult', message, 'success');
            
            if (!isUpdate) {
                e.target.reset();
            } else {
                // Reset form to registration mode
                delete e.target.dataset.patientId;
                e.target.querySelector('button[type="submit"]').textContent = 'Register Patient';
            }
        } else {
            showMessage('registrationResult', result.detail || 'Operation failed', 'error');
        }
    } catch (error) {
        showMessage('registrationResult', 'Error: ' + error.message, 'error');
    }
});

// Helper function to show messages
function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    const className = type === 'success' ? 'alert-success' : 'alert-error';
    element.innerHTML = `<div class="alert ${className}">${message}</div>`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        element.innerHTML = '';
    }, 5000);
}
</script>
{% endblock %}
